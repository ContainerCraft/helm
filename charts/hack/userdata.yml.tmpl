#;!/bin/bash

cat <<EOF > hack/userdata.yml
#cloud-config
ssh_authorized_keys:
  - $(cat ~/.ssh/id_rsa.pub)
vyos_config_commands:
  - configure
  - set firewall all-ping 'enable'
  - set firewall syn-cookies 'enable'
  - set firewall config-trap 'disable'
  - set firewall log-martians 'enable'
  - set firewall ip-src-route 'disable'
  - set firewall send-redirects 'enable'
  - set firewall broadcast-ping 'disable'
  - set firewall ipv6-src-route 'disable'
  - set firewall source-validation 'disable'
  - set firewall receive-redirects 'disable'
  - set firewall ipv6-receive-redirects 'disable'
  - set firewall twa-hazards-protection 'disable'
  - set firewall name OUTSIDE-IN default-action 'drop'
  - set firewall name OUTSIDE-IN rule 10 action 'accept'
  - set firewall name OUTSIDE-IN rule 10 state established 'enable'
  - set firewall name OUTSIDE-IN rule 10 state related 'enable'
  - set firewall name OUTSIDE-LOCAL default-action 'drop'
  - set firewall name OUTSIDE-LOCAL rule 10 action 'accept'
  - set firewall name OUTSIDE-LOCAL rule 10 state established 'enable'
  - set firewall name OUTSIDE-LOCAL rule 10 state related 'enable'
  - set firewall name OUTSIDE-LOCAL rule 20 action 'accept'
  - set firewall name PUBLIC-IN default-action 'drop'
  - set firewall name PUBLIC-IN rule 10 action 'accept'
  - set firewall name PUBLIC-IN rule 10 state established 'enable'
  - set firewall name PUBLIC-IN rule 10 state related 'enable'
  - set firewall name PUBLIC-LOCAL default-action 'drop'
  - set firewall name PUBLIC-LOCAL rule 10 action 'accept'
  - set firewall name PUBLIC-LOCAL rule 10 state established 'enable'
  - set firewall name PUBLIC-LOCAL rule 10 state related 'enable'
  - set firewall name PUBLIC-LOCAL rule 20 action 'accept'
  - set firewall name PUBLIC-LOCAL rule 20 icmp type-name 'echo-request'
  - set firewall name PUBLIC-LOCAL rule 20 protocol 'icmp'
  - set firewall name PUBLIC-LOCAL rule 20 state new 'enable'
  - set firewall name PUBLIC-LOCAL rule 30 action 'drop'
  - set firewall name PUBLIC-LOCAL rule 31 destination port '2222'
  - set firewall name PUBLIC-LOCAL rule 31 protocol 'tcp'
  - set firewall name PUBLIC-LOCAL rule 31 recent count '4'
  - set firewall name PUBLIC-LOCAL rule 31 recent time '60'
  - set firewall name PUBLIC-LOCAL rule 31 state new 'enable'
  - set firewall name PUBLIC-LOCAL rule 32 action 'accept'
  - set firewall name PUBLIC-LOCAL rule 32 destination port '2222'
  - set firewall name PUBLIC-LOCAL rule 32 protocol 'tcp'
  - set firewall name PUBLIC-LOCAL rule 32 state new 'enable'
  - set interfaces ethernet eth0 address 'dhcp'
  - set interfaces ethernet eth0 address 'dhcpv6'
  - set interfaces ethernet eth0 description 'PUBLIC'
  - set interfaces ethernet eth0 firewall in name 'PUBLIC-IN'
  - set interfaces ethernet eth0 firewall local name 'PUBLIC-LOCAL'
  - set interfaces ethernet eth1 address '192.168.16.1/24'
  - set interfaces ethernet eth1 description 'LAN'
  - set interfaces loopback lo
  - set nat source rule 100 outbound-interface 'eth0'
  - set nat source rule 100 translation address 'masquerade'
  - set protocols static route 0.0.0.0/0 next-hop 192.168.11
  - set service dns forwarding cache-size '1000'
  - set service dns forwarding allow-from '0.0.0.0/0'
  - set service dns forwarding listen-address '0.0.0.0'
  - set service dns forwarding name-server '192.168.1.1'
  - set service dns forwarding name-server '1.1.1.1'
  - set system name-server '127.0.0.1'
  - set service ssh client-keepalive-interval '180'
  - set service ssh listen-address '0.0.0.0'
  - set service ssh port '2222'
  - delete service ssh port '22'
  - set system config-management commit-revisions '100'
  - set system console device ttyS0 speed '9600'
  - set system host-name 'vyos-dmz'
  - set system domain-name 'dmz.home.arpa'
  - set system login user vyos authentication public-keys vyos key 'AAAAB3NzaC1yc2EAAAADAQABAAAB/zPcAdyHRElufWDNQ1mZUWp4V9jDmaWX35ApsXgxfMHBuz3n8VLGVJuXodAAxeRbbE7Rws8BQcCH4DAMKKLHYZRdJtk3ZUw7rm0i/aq0wkeld7Yp6H/fv1ud3mudp7/+3fQ3gV8RmAO8+FS4jNBMciqtY6mWThKciwnkBWmH5atl6GsZ1ZQ+Y8+W4hXnaF6UEU1+xZ8ja+hu81a9fhejcV+m3RwT511kW5IXDe6wkq9tsIEC529VGI7XuySYvusbchivWYxmE+TBMmId3voGCfkl8hIemUG3/LvQWeK95B/6vBKDCFlmABn60zxrjPkdknWPbu4zg+VJWnslX+rDqSe2cBpHqQ8yDxegPcmXNKv2Qp0h8HhEljWoLc4U5x4hlceDraWBehj8i4N6p+Yt678+jUpOCwGC8z9l+zUrG6NPvbHZ2aIBC3eUteYPtmScNLvOiFASPo/9GQQDNqZclQZf5QGDToAV2rV1B4jJPV8fv/1rlgen6O1PNitKo9FlUfr0WA1IXev6CiJUt4x210BzhTlD84S2A0gHJRbeVVkjWKMx/vo/wqEKTg/vvzSOhFDDlKUxSsguL5rrtOxdGj4sUtjeVRuDjwk1u1DH8P75rI0R/1QaeDixJbRi8Q1315z+MrvJuvzJpMTieldqffNUnexMZcFox8yI8KlVt2U='
  - set system login user vyos authentication public-keys vyos type 'ssh-rsa'
  - set service ssh disable-password-authentication
  - set system ntp server 0.pool.ntp.org
  - set system ntp server 1.pool.ntp.org
  - set system ntp server 2.pool.ntp.org
  - set system syslog global facility all level 'notice'
  - set system syslog global facility protocols level 'debug'
  - set nat destination rule 70 description 'Port Forward public ssh port 22 to bastion 192.168.16.12 port 22'
  - set nat destination rule 70 inbound-interface 'eth0'
  - set nat destination rule 70 translation address '192.168.16.12'
  - set nat destination rule 70 destination port '22'
  - set nat destination rule 70 translation port '22'
  - set nat destination rule 70 protocol 'tcp'
  - set firewall name PUBLIC-IN rule 71 description 'Allow Port Forward public ssh port 22 to bastion 192.168.16.12 port 22'
  - set firewall name PUBLIC-IN rule 71 action 'accept'
  - set firewall name PUBLIC-IN rule 71 destination address '192.168.1.139'
  - set firewall name PUBLIC-IN rule 71 destination port '22'
  - set firewall name PUBLIC-IN rule 71 protocol 'tcp'
  - set firewall name PUBLIC-IN rule 71 state new 'enable'
  - set firewall name PUBLIC-IN rule 72 action 'accept'
  - set firewall name PUBLIC-IN rule 72 destination port '22'
  - set firewall name PUBLIC-IN rule 72 protocol 'tcp'
  - set firewall name PUBLIC-IN rule 72 state new 'enable'
  - set firewall name PUBLIC-IN rule 81 protocol 'tcp'
  - set firewall name PUBLIC-IN rule 81 destination port '3389'
  - set firewall name PUBLIC-IN rule 81 recent count '4'
  - set firewall name PUBLIC-IN rule 81 recent time '60'
  - set firewall name PUBLIC-IN rule 81 state new 'enable'
  - set firewall name PUBLIC-IN rule 83 action 'accept'
  - set firewall name PUBLIC-IN rule 83 destination port '3389'
  - set firewall name PUBLIC-IN rule 83 protocol 'tcp'
  - set firewall name PUBLIC-IN rule 83 state new 'enable'
  - set nat destination rule 80 description 'Port Forward public RDP port 3389 to bastion 192.168.16.12 port 3389'
  - set nat destination rule 80 inbound-interface 'eth0'
  - set nat destination rule 80 translation address '192.168.16.12'
  - set nat destination rule 80 destination port '3389'
  - set nat destination rule 80 translation port '3389'
  - set nat destination rule 80 protocol 'tcp'
  - commit
  - save
EOF
